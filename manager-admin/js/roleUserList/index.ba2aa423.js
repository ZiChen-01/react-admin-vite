import{r as e,F as s,j as t,M as a,e as l,m as r,D as n,A as i,a7 as d,Q as c,V as o,Y as u,a4 as h,a5 as x,a6 as m,a8 as j,B as g,k as p,a9 as k,b as y,aa as S,S as C}from"../.store/.store.b566568b.js";import{r as f,g as b,s as w}from"../index.66ef1ddd.js";const I=e.forwardRef(((n,i)=>{let[d,c]=e.useState(!1),[o,u]=e.useState("0"),[h,x]=e.useState(null),[m]=s.useForm(),{TextArea:j}=l;e.useImperativeHandle(i,(()=>({setIsModalOpen:c,setEditForm:g,setTitle:u,setUserId:x})));const g=e=>{m.setFieldsValue({roleCode:e.roleCode,roleName:e.roleName,description:e.description})};return t.jsx(t.Fragment,{children:t.jsx(a,{title:0==o?"新增角色":"编辑角色",open:d,okText:"提交",cancelText:"取消",onOk:async()=>{try{const e=await m.validateFields();0==o?f.addRole(e).then((e=>{200==e.data.code&&(r.success(e.data.message),n.getList(),c(!1),m.resetFields())})):1==o&&(e.id=h,f.editRole(e).then((e=>{200==e.data.code&&(r.success(e.data.message),n.getList(),c(!1),m.resetFields())})))}catch(e){}},onCancel:()=>{c(!1),m.resetFields()},className:"AddRole",width:"50%",children:t.jsxs(s,{name:"basic",form:m,labelCol:{span:3},wrapperCol:{span:20},initialValues:{remember:!0},children:[t.jsx(s.Item,{label:"角色编码",name:"roleCode",rules:[{required:!0,message:"请输入角色编码!"},{validator:async(e,s)=>{const t={tableName:"sys_role",fieldName:"role_code",fieldVal:s,dataId:h};if(500==(await f.duplicateCheck(t)).data.code)throw new Error("角色编码已存在!")}}],children:t.jsx(l,{placeholder:"请输入角色编码",disabled:1==o})}),t.jsx(s.Item,{label:"角色名称",name:"roleName",rules:[{required:!0,message:"请输入角色名称!"}],children:t.jsx(l,{placeholder:"请输入角色名称"})}),t.jsx(s.Item,{label:"描述",name:"description",rules:[{required:!1,message:""}],children:t.jsx(j,{rows:4,placeholder:"请输入描述"})})]})})})})),N=e.forwardRef(((a,g)=>{let[p,k]=e.useState(!1),[y,S]=e.useState({}),[C,b]=e.useState(!1),[w,I]=e.useState([]),[N,v]=e.useState([]),[R,T]=e.useState([]),[F,z]=e.useState(""),[L,A]=e.useState("1"),[U,O]=e.useState(null);e.useImperativeHandle(g,(()=>({setLookVisible:k,setDetails:S,getUserlist:X,getAllUserlist:$,setActiveKey:A})));let[D,K]=e.useState(0),[M,E]=e.useState(1),[V,q]=e.useState(10),P={current:M,pageSize:V,pageSizeOptions:["10","20","30","50","100"],showTotal:(e,s)=>s[0]+"-"+s[1]+" 共"+e+"条",showQuickJumper:!1,showSizeChanger:!0,total:D,onChange:e=>{E(e)},onShowSizeChange:(e,s)=>{q(s),E(1)}};e.useEffect((()=>{U&&X(U)}),[M,V]);const J=[{title:"用户账号",dataIndex:"username",align:"center",key:"username"},{title:"用户姓名",align:"center",dataIndex:"realname",key:"realname"},{title:"工号",align:"center",key:"workNo",dataIndex:"workNo"},{title:"操作",dataIndex:"action",align:"center",render:(e,s,a)=>t.jsx(t.Fragment,{children:t.jsx(j,{title:"确定要从此角色移出此用户?",onConfirm:()=>Z(s),okText:"确定",cancelText:"取消",children:t.jsx("a",{children:"移出此用户"})})})}];let[Q,_]=e.useState(0),[B,H]=e.useState(1),[Y,G]=e.useState(10),W={current:B,pageSize:Y,pageSizeOptions:["10","20","30","50","100"],showTotal:(e,s)=>s[0]+"-"+s[1]+" 共"+e+"条",showQuickJumper:!1,showSizeChanger:!0,total:Q,onChange:e=>{H(e)},onShowSizeChange:(e,s)=>{G(s),H(1)}};e.useEffect((()=>{$()}),[B,Y]);const X=e=>{O(e),b(!0);let s={roleId:e.id,pageNo:M,pageSize:V};f.userRoleList(s).then((e=>{0==e.data.code&&(I(e.data.result.records),K(e.data.result.total)),b(!1)}))},Z=e=>{let s={userId:e.id,roleId:y.id};f.deleteUserRole(s).then((e=>{200==e.data.code&&(r.success(e.data.message),X(y))}))},$=()=>{b(!0);let e={username:F,pageNo:B,pageSize:Y};f.getUserList(e).then((e=>{0==e.data.code&&(v(e.data.result.records),_(e.data.result.total)),b(!1)}))},ee={onChange:(e,s)=>{T(e)},getCheckboxProps:e=>({disabled:w.some((s=>s.id===e.id))})};return e.useEffect((()=>{}),[M]),t.jsx(t.Fragment,{children:t.jsxs(n,{title:"查看用户",open:p,closable:!1,onClose:()=>{k(!1)},width:"40%",footer:null,className:"lookUsers",children:[t.jsxs("p",{className:"lookUsers-title",children:[t.jsxs("span",{children:["当前角色：",y.roleName]}),t.jsxs("span",{children:["当前角色编码：",y.roleCode]})]}),t.jsx(i,{className:"iconDIV",defaultActiveKey:"1",onChange:e=>{A(e)},activeKey:L,items:[{label:"当前角色用户",key:"1",children:t.jsx(d,{rowKey:e=>e.id,dataSource:w,columns:J,loading:C,pagination:P})},{label:"添加已有用户",key:"2",children:t.jsxs(t.Fragment,{children:[t.jsxs(c,{gutter:15,children:[t.jsx(o,{md:12,sm:15,children:t.jsx(s.Item,{label:"账号",children:t.jsx(l,{value:F,onChange:e=>z(e.target.value),placeholder:"请输入账号"})})}),t.jsxs(o,{children:[t.jsx(u,{type:"primary",icon:t.jsx(h,{}),onClick:$,children:"查询"}),t.jsx(u,{type:"primary",icon:t.jsx(x,{}),onClick:()=>{z(""),H(1),F="",B=1,$()},className:"searchreset",children:"重置"}),0!=R.length?t.jsx(u,{type:"primary",icon:t.jsx(m,{}),onClick:()=>{let e={roleId:y.id,userIdList:R};f.addSysUserRole(e).then((e=>{0==e.data.code&&(r.success(e.data.message),A("1"),X(y),T([]))}))},className:"searchreset",children:"添加"}):""]})]}),t.jsx(d,{rowKey:e=>e.id,dataSource:N,columns:[{title:"用户账号",dataIndex:"username",align:"center",key:"username"},{title:"用户姓名",align:"center",dataIndex:"realname",key:"realname"},{title:"工号",align:"center",key:"workNo",dataIndex:"workNo"}],loading:C,pagination:W,rowSelection:{selectedRowKeys:R,...ee}})]})}]})]})})})),v=e.forwardRef(((s,a)=>{var l;let[i,d]=e.useState(!1),[h,x]=e.useState(!1),[m,j]=e.useState({}),[C,I]=e.useState([]),[N,v]=e.useState([]),[R,T]=e.useState([]),[F,z]=e.useState([]),[L,A]=e.useState([]),[U,O]=e.useState(!0);const D=null==(l=JSON.parse(localStorage.getItem(window.envConfig.ROOT_APP_INFO)))?void 0:l.roleInfo;e.useImperativeHandle(a,(()=>({setMenuVisible:x,queryMenuTreeList:K,setDetails:j})));const K=(e=null)=>{d(!0),f.queryMenuTreeList().then((s=>{if(0==s.data.code){let t=function(e){for(let s=0;s<e.length;s++){const a=e[s];l.includes(a.title)&&(a.disabled=!0),a.children&&t(a.children)}},a=M(s.data.result.treeList),l=["首页","系统管理","用户管理","角色管理","菜单管理","机构管理"];e&&"admin"==e.roleCode&&t(a),I(a),z(s.data.result.ids),T(s.data.result.ids),E(e)}}))},M=e=>(e.forEach((e=>{e.title=e.slotTitle,e.children&&M(e.children)})),e),E=e=>{f.queryRolePermission({roleId:e.id}).then((e=>{d(!1),0==e.data.code&&(v(e.data.result),A(e.data.result))}))};return t.jsx(t.Fragment,{children:t.jsx(n,{title:"菜单角色权限配置",open:h,closable:!1,onClose:()=>{x(!1)},width:"40%",className:"MenuAuthorization",footer:t.jsx(t.Fragment,{children:t.jsxs(c,{justify:"space-between",className:"searchBar",children:[t.jsx(o,{children:t.jsx(g,{trigger:["click"],menu:{items:[{label:t.jsxs("a",{children:[" 父子关联 ",U?"":t.jsx(p,{})]}),key:"1"},{label:t.jsxs("a",{children:[" 取消关联 ",U?t.jsx(p,{}):""]}),key:"2"},{label:t.jsxs("a",{children:[" 全部勾选 ",N.length==R.length?t.jsx(p,{}):""]}),key:"3"},{label:t.jsxs("a",{children:[" 取消全选 ",N.length!=R.length?t.jsx(p,{}):""]}),key:"4"},{label:t.jsxs("a",{children:[" 展开所有 ",F.length==R.length?t.jsx(p,{}):""]}),key:"5"},{label:t.jsxs("a",{children:[" 合并所有 ",F.length!=R.length?t.jsx(p,{}):""]}),key:"6"}],onClick:e=>(({key:e})=>{switch(e){case"1":O(!1);break;case"2":O(!0);break;case"3":v(R);break;case"4":v([]);break;case"5":z(R);break;case"6":z([])}})(e)},children:t.jsx("a",{onClick:e=>{e.preventDefault()},children:t.jsxs(u,{children:["树操作",t.jsx(k,{})]})})})}),t.jsxs(o,{children:[t.jsx(u,{onClick:()=>{x(!1)},style:{marginRight:".5vw"},children:"取消"}),t.jsx(u,{type:"primary",onClick:()=>{let e={lastpermissionIds:L.join(","),permissionIds:N.join(","),roleId:m.id};f.saveRolePermission(e).then((e=>{200==e.data.code&&(D.roleCode==m.roleCode?D.roleCode==m.roleCode&&(r.loading("正在初始化菜单，请稍后"),b().then((e=>{w.dispatch({type:"reload",data:!0})}))):r.success(e.data.message)),E(m),x(!1)}))},children:"提交"})]})]})}),children:t.jsx(y,{spinning:i,children:t.jsx(S,{checkable:!0,onCheck:(e,s)=>{e=Array.isArray(e)?e:e.checked,v(e)},treeData:C,checkedKeys:N,expandedKeys:F,checkStrictly:U,onExpand:e=>{z(e)}})})})})}));function R(){let[a,n]=e.useState(!1),[i,p]=e.useState([]),[k,y]=e.useState(""),S=e.useRef(null),b=e.useRef(null),w=e.useRef(null),[R,T]=e.useState(0),[F,z]=e.useState(1),[L,A]=e.useState(10),U={current:F,pageSize:L,pageSizeOptions:["10","20","30","50","100"],showTotal:(e,s)=>s[0]+"-"+s[1]+" 共"+e+"条",showQuickJumper:!1,showSizeChanger:!0,total:R,onChange:e=>{z(e)},onShowSizeChange:(e,s)=>{A(s),z(1)}};const O=[{title:"角色编码",align:"center",dataIndex:"roleCode"},{title:"角色名称",align:"center",dataIndex:"roleName"},{title:"创建时间",dataIndex:"createTime",align:"center"},{title:"操作",dataIndex:"action",align:"center",render:(e,s,a)=>t.jsxs(t.Fragment,{children:[t.jsx("a",{onClick:()=>K(s),children:"查看用户"}),t.jsx(g,{menu:{items:[{label:t.jsx("a",{children:" 菜单授权"}),key:"1"},{label:t.jsx("a",{children:" 编辑角色"}),key:"2"},{label:t.jsx(j,{Popconfirm:!0,title:"确定要删除此角色?",onConfirm:()=>E(s),okText:"确定",cancelText:"取消",children:t.jsx("a",{children:" 删除角色"})}),key:"3",disabled:s.roleCode.includes("admin")}],onClick:e=>M(e,s)},children:t.jsx("a",{onClick:e=>{e.preventDefault()},children:t.jsx(C,{children:"更多"})})})]})}],D=()=>{n(!0);let e={roleName:k,pageNo:F,pageSize:L};f.queryRoleList(e).then((e=>{n(!1),0==e.data.code&&(p(e.data.result.records),T(e.data.result.total))}))},K=e=>{b.current.setLookVisible(!0),b.current.setDetails(e),b.current.getUserlist(e),b.current.getAllUserlist(),b.current.setActiveKey("1")},M=({key:e},s)=>{switch(e){case"1":w.current.setMenuVisible(!0),w.current.setDetails(s),w.current.queryMenuTreeList(s);break;case"2":S.current.setIsModalOpen(!0),S.current.setTitle("1"),S.current.setUserId(s.id),S.current.setEditForm(s)}},E=e=>{f.roleDelete({id:e.id}).then((e=>{200==e.data.code&&(r.success(e.data.message),D())}))};return e.useEffect((()=>{D()}),[F,L]),t.jsx(t.Fragment,{children:t.jsxs("div",{className:"roleUserList",children:[t.jsxs(c,{gutter:24,children:[t.jsx(o,{span:6,children:t.jsx(s.Item,{label:"角色名称",children:t.jsx(l,{value:k,onChange:e=>y(e.target.value),placeholder:"请输入角色名称"})})}),t.jsx(o,{span:6})]}),t.jsxs(c,{justify:"space-between",className:"searchBar",children:[t.jsxs(o,{children:[t.jsx(u,{type:"primary",icon:t.jsx(h,{}),onClick:()=>{D(),z(1),A(10)},children:"查询"}),t.jsx(u,{type:"primary",icon:t.jsx(x,{}),onClick:()=>{y(""),k="",D()},className:"searchreset",children:"重置"})]}),t.jsx(o,{children:t.jsx(u,{type:"primary",icon:t.jsx(m,{}),onClick:()=>{S.current.setIsModalOpen(!0),S.current.setTitle("0")},children:"添加角色"})})]}),t.jsx(d,{rowKey:e=>e.id,dataSource:i,columns:O,loading:a,pagination:U,expandable:{expandedRowRender:e=>t.jsxs("p",{style:{margin:0},children:["描述：",e.description]})}}),t.jsx(I,{ref:S,getList:D}),t.jsx(N,{ref:b}),t.jsx(v,{ref:w})]})})}export{R as default};
